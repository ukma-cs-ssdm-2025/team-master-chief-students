name: Check Commit Message

on:
    pull_request:
        types: [opened, synchronize]

jobs:
    check-commit-message:
        name: Check Commit Message Format
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Validate All PR Commit Messages
              run: |
                  BASE_COMMIT=${{ github.event.pull_request.base.sha }}
                  HEAD_COMMIT=${{ github.event.pull_request.head.sha }}
                  
                  REGEX="^(feat|fix|docs|chore)\(#([0-9]+)\): .+ \((closes|fixes|resolves) #\2\)$"
                  
                  echo "Checking commits between $BASE_COMMIT and $HEAD_COMMIT..."
                  
                  git log --pretty=%s $BASE_COMMIT..$HEAD_COMMIT | while read -r COMMIT_MSG; do
                    if [ -z "$COMMIT_MSG" ]; then
                      continue
                    fi
                  
                    echo "------------------------------------------------"
                    echo "Checking commit subject: $COMMIT_MSG"

                    if [[ "$COMMIT_MSG" == "Merge remote-tracking branch"* ]]; then
                      echo "‚û°Ô∏è Skipping merge commit."
                      continue # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–º—ñ—Ç—É
                    fi
                    # ============================
                  
                    if [[ ! "$COMMIT_MSG" =~ $REGEX ]]; then
                      echo "üö´ Error: The commit message does not match the required format."
                      echo "   Expected format: type(#issue): message (closes|fixes|resolves #issue)"
                      echo "   Example: feat(#123): add new login button (closes #123)"
                      exit 1
                    else
                      echo "‚úÖ Commit message format is correct."
                    fi
                  done
                  
                  echo "------------------------------------------------"
                  echo "üéâ All commit messages in the PR are formatted correctly."